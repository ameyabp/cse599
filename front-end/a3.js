var initViewportWidth = Math.round(window.innerWidth * 0.9);
var initViewportHeight = Math.round(window.innerHeight * 0.8);

earth_border = {
    "type": "MultiLineString",
    "coordinates": [
        [
            [
                -180,
                -89.999999
            ],
            [
                -180,
                9.999999974752427e-7
            ],
            [
                -180,
                89.999999
            ],
            [
                -180,
                90
            ],
            [
                -177.5,
                90
            ],
            [
                -175,
                90
            ],
            [
                -172.5,
                90
            ],
            [
                -170,
                90
            ],
            [
                -167.5,
                90
            ],
            [
                -165,
                90
            ],
            [
                -162.5,
                90
            ],
            [
                -160,
                90
            ],
            [
                -157.5,
                90
            ],
            [
                -155,
                90
            ],
            [
                -152.5,
                90
            ],
            [
                -150,
                90
            ],
            [
                -147.5,
                90
            ],
            [
                -145,
                90
            ],
            [
                -142.5,
                90
            ],
            [
                -140,
                90
            ],
            [
                -137.5,
                90
            ],
            [
                -135,
                90
            ],
            [
                -132.5,
                90
            ],
            [
                -130,
                90
            ],
            [
                -127.5,
                90
            ],
            [
                -125,
                90
            ],
            [
                -122.5,
                90
            ],
            [
                -120,
                90
            ],
            [
                -117.5,
                90
            ],
            [
                -115,
                90
            ],
            [
                -112.5,
                90
            ],
            [
                -110,
                90
            ],
            [
                -107.5,
                90
            ],
            [
                -105,
                90
            ],
            [
                -102.5,
                90
            ],
            [
                -100,
                90
            ],
            [
                -97.5,
                90
            ],
            [
                -95,
                90
            ],
            [
                -92.5,
                90
            ],
            [
                -90,
                90
            ],
            [
                -87.5,
                90
            ],
            [
                -85,
                90
            ],
            [
                -82.5,
                90
            ],
            [
                -90,
                90
            ],
            [
                -77.5,
                90
            ],
            [
                -75,
                90
            ],
            [
                -72.5,
                90
            ],
            [
                -70,
                90
            ],
            [
                -67.5,
                90
            ],
            [
                -65,
                90
            ],
            [
                -62.5,
                90
            ],
            [
                -60,
                90
            ],
            [
                -57.5,
                90
            ],
            [
                -55,
                90
            ],
            [
                -52.5,
                90
            ],
            [
                -50,
                90
            ],
            [
                -47.5,
                90
            ],
            [
                -45,
                90
            ],
            [
                -42.5,
                90
            ],
            [
                -40,
                90
            ],
            [
                -37.5,
                90
            ],
            [
                -35,
                90
            ],
            [
                -32.5,
                90
            ],
            [
                -30,
                90
            ],
            [
                -27.5,
                90
            ],
            [
                -25,
                90
            ],
            [
                -22.5,
                90
            ],
            [
                -20,
                90
            ],
            [
                -17.5,
                90
            ],
            [
                -15,
                90
            ],
            [
                -12.5,
                90
            ],
            [
                -10,
                90
            ],
            [
                -7.5,
                90
            ],
            [
                -5,
                90
            ],
            [
                -2.5,
                90
            ],
            [
                0,
                90
            ],
            [
                2.5,
                90
            ],
            [
                5,
                90
            ],
            [
                7.5,
                90
            ],
            [
                10,
                90
            ],
            [
                12.5,
                90
            ],
            [
                15,
                90
            ],
            [
                17.5,
                90
            ],
            [
                20,
                90
            ],
            [
                22.5,
                90
            ],
            [
                25,
                90
            ],
            [
                27.5,
                90
            ],
            [
                30,
                90
            ],
            [
                32.5,
                90
            ],
            [
                35,
                90
            ],
            [
                37.5,
                90
            ],
            [
                40,
                90
            ],
            [
                42.5,
                90
            ],
            [
                45,
                90
            ],
            [
                47.5,
                90
            ],
            [
                50,
                90
            ],
            [
                52.5,
                90
            ],
            [
                55,
                90
            ],
            [
                57.5,
                90
            ],
            [
                60,
                90
            ],
            [
                62.5,
                90
            ],
            [
                65,
                90
            ],
            [
                67.5,
                90
            ],
            [
                70,
                90
            ],
            [
                72.5,
                90
            ],
            [
                75,
                90
            ],
            [
                77.5,
                90
            ],
            [
                90,
                90
            ],
            [
                82.5,
                90
            ],
            [
                85,
                90
            ],
            [
                87.5,
                90
            ],
            [
                90,
                90
            ],
            [
                92.5,
                90
            ],
            [
                95,
                90
            ],
            [
                97.5,
                90
            ],
            [
                100,
                90
            ],
            [
                102.5,
                90
            ],
            [
                105,
                90
            ],
            [
                107.5,
                90
            ],
            [
                110,
                90
            ],
            [
                112.5,
                90
            ],
            [
                115,
                90
            ],
            [
                117.5,
                90
            ],
            [
                120,
                90
            ],
            [
                122.5,
                90
            ],
            [
                125,
                90
            ],
            [
                127.5,
                90
            ],
            [
                130,
                90
            ],
            [
                132.5,
                90
            ],
            [
                135,
                90
            ],
            [
                137.5,
                90
            ],
            [
                140,
                90
            ],
            [
                142.5,
                90
            ],
            [
                145,
                90
            ],
            [
                147.5,
                90
            ],
            [
                150,
                90
            ],
            [
                152.5,
                90
            ],
            [
                155,
                90
            ],
            [
                157.5,
                90
            ],
            [
                160,
                90
            ],
            [
                162.5,
                90
            ],
            [
                165,
                90
            ],
            [
                167.5,
                90
            ],
            [
                170,
                90
            ],
            [
                172.5,
                90
            ],
            [
                175,
                90
            ],
            [
                177.5,
                90
            ],
            [
                180,
                90
            ],
            [
                180,
                89.999999
            ],
            [
                180,
                9.999999974752427e-7
            ],
            [
                180,
                -89.999999
            ],
            [
                180,
                -90
            ],
            [
                177.5,
                -90
            ],
            [
                175,
                -90
            ],
            [
                172.5,
                -90
            ],
            [
                170,
                -90
            ],
            [
                167.5,
                -90
            ],
            [
                165,
                -90
            ],
            [
                162.5,
                -90
            ],
            [
                160,
                -90
            ],
            [
                157.5,
                -90
            ],
            [
                155,
                -90
            ],
            [
                152.5,
                -90
            ],
            [
                150,
                -90
            ],
            [
                147.5,
                -90
            ],
            [
                145,
                -90
            ],
            [
                142.5,
                -90
            ],
            [
                140,
                -90
            ],
            [
                137.5,
                -90
            ],
            [
                135,
                -90
            ],
            [
                132.5,
                -90
            ],
            [
                130,
                -90
            ],
            [
                127.5,
                -90
            ],
            [
                125,
                -90
            ],
            [
                122.5,
                -90
            ],
            [
                120,
                -90
            ],
            [
                117.5,
                -90
            ],
            [
                115,
                -90
            ],
            [
                112.5,
                -90
            ],
            [
                110,
                -90
            ],
            [
                107.5,
                -90
            ],
            [
                105,
                -90
            ],
            [
                102.5,
                -90
            ],
            [
                100,
                -90
            ],
            [
                97.5,
                -90
            ],
            [
                95,
                -90
            ],
            [
                92.5,
                -90
            ],
            [
                90,
                -90
            ],
            [
                87.5,
                -90
            ],
            [
                85,
                -90
            ],
            [
                82.5,
                -90
            ],
            [
                90,
                -90
            ],
            [
                77.5,
                -90
            ],
            [
                75,
                -90
            ],
            [
                72.5,
                -90
            ],
            [
                70,
                -90
            ],
            [
                67.5,
                -90
            ],
            [
                65,
                -90
            ],
            [
                62.5,
                -90
            ],
            [
                60,
                -90
            ],
            [
                57.5,
                -90
            ],
            [
                55,
                -90
            ],
            [
                52.5,
                -90
            ],
            [
                50,
                -90
            ],
            [
                47.5,
                -90
            ],
            [
                45,
                -90
            ],
            [
                42.5,
                -90
            ],
            [
                40,
                -90
            ],
            [
                37.5,
                -90
            ],
            [
                35,
                -90
            ],
            [
                32.5,
                -90
            ],
            [
                30,
                -90
            ],
            [
                27.5,
                -90
            ],
            [
                25,
                -90
            ],
            [
                22.5,
                -90
            ],
            [
                20,
                -90
            ],
            [
                17.5,
                -90
            ],
            [
                15,
                -90
            ],
            [
                12.5,
                -90
            ],
            [
                10,
                -90
            ],
            [
                7.5,
                -90
            ],
            [
                5,
                -90
            ],
            [
                2.5,
                -90
            ],
            [
                0,
                -90
            ],
            [
                -2.5,
                -90
            ],
            [
                -5,
                -90
            ],
            [
                -7.5,
                -90
            ],
            [
                -10,
                -90
            ],
            [
                -12.5,
                -90
            ],
            [
                -15,
                -90
            ],
            [
                -17.5,
                -90
            ],
            [
                -20,
                -90
            ],
            [
                -22.5,
                -90
            ],
            [
                -25,
                -90
            ],
            [
                -27.5,
                -90
            ],
            [
                -30,
                -90
            ],
            [
                -32.5,
                -90
            ],
            [
                -35,
                -90
            ],
            [
                -37.5,
                -90
            ],
            [
                -40,
                -90
            ],
            [
                -42.5,
                -90
            ],
            [
                -45,
                -90
            ],
            [
                -47.5,
                -90
            ],
            [
                -50,
                -90
            ],
            [
                -52.5,
                -90
            ],
            [
                -55,
                -90
            ],
            [
                -57.5,
                -90
            ],
            [
                -60,
                -90
            ],
            [
                -62.5,
                -90
            ],
            [
                -65,
                -90
            ],
            [
                -67.5,
                -90
            ],
            [
                -70,
                -90
            ],
            [
                -72.5,
                -90
            ],
            [
                -75,
                -90
            ],
            [
                -77.5,
                -90
            ],
            [
                -80,
                -90
            ],
            [
                -82.5,
                -90
            ],
            [
                -85,
                -90
            ],
            [
                -87.5,
                -90
            ],
            [
                -90,
                -90
            ],
            [
                -92.5,
                -90
            ],
            [
                -95,
                -90
            ],
            [
                -97.5,
                -90
            ],
            [
                -100,
                -90
            ],
            [
                -102.5,
                -90
            ],
            [
                -105,
                -90
            ],
            [
                -107.5,
                -90
            ],
            [
                -110,
                -90
            ],
            [
                -112.5,
                -90
            ],
            [
                -115,
                -90
            ],
            [
                -117.5,
                -90
            ],
            [
                -120,
                -90
            ],
            [
                -122.5,
                -90
            ],
            [
                -125,
                -90
            ],
            [
                -127.5,
                -90
            ],
            [
                -130,
                -90
            ],
            [
                -132.5,
                -90
            ],
            [
                -135,
                -90
            ],
            [
                -137.5,
                -90
            ],
            [
                -140,
                -90
            ],
            [
                -142.5,
                -90
            ],
            [
                -145,
                -90
            ],
            [
                -147.5,
                -90
            ],
            [
                -150,
                -90
            ],
            [
                -152.5,
                -90
            ],
            [
                -155,
                -90
            ],
            [
                -157.5,
                -90
            ],
            [
                -160,
                -90
            ],
            [
                -162.5,
                -90
            ],
            [
                -165,
                -90
            ],
            [
                -167.5,
                -90
            ],
            [
                -170,
                -90
            ],
            [
                -172.5,
                -90
            ],
            [
                -175,
                -90
            ],
            [
                -177.5,
                -90
            ],
            [
                -180,
                -90
            ]
        ]
    ]
}

var species = ['Unknown', 'Pilot', 'Bottlenose', 'Killer', 'Blue', 'Fin', 'Sperm', 'Humpback', 'Sei', 'Common Minke',
                "Bryde's", 'Right', 'Gray', "Baird's Beaked", 'Baleen', 'Pygmy Blue', 'Pygmy Right', "Cuvier's Beaked",
                'Bowhead', 'Beaked (unspecified)', 'Antarctic Minke', "Sei/Bryde's", "Dolphin"];

var svgMap = d3.select(".kyrix-panel")
                .attr("width", initViewportWidth)
                .attr("height", initViewportHeight)
                .append("svg")
                .attr("id", "map")
                .attr("width", initViewportWidth)
                .attr("height", initViewportHeight)
                .attr("viewBox", [0, 0, initViewportWidth, initViewportHeight])
                .append("g");

function zoomed(event) {
    svgMap.attr("transform", event.transform);
}

var zoom = d3.zoom()
            .extent([[0,0], [initViewportWidth, initViewportHeight]])
            .scaleExtent([1,8]) // how deep to zoom-in (8) and how far to zoom-out (1)
            .translateExtent([[0,0], [initViewportWidth, initViewportHeight]])  // how far to pan top and left [0,0], and bottom and right [initViewportWidth, initViewportHeight]
            .on("zoom", zoomed);

svgMap.call(zoom);

function resetViewport() {
    svgMap.transition()
            .duration(500)
            .call(zoom.transform, d3.zoomIdentity);
}

var projection = d3.geoNaturalEarth1()
                .scale(300)
                .translate([initViewportWidth/2, initViewportHeight/2]);
                // .rotate([-11,0,0]);   // shift part of Russia from west of the map to the east

var path = d3.geoPath().projection(projection);

// Append Div for tooltip to BODY and not to SVG!!!
var tt = d3.select("body").append("div")   
                .attr("class", "tooltip")           
                .style("opacity", 0);

// get radio choices
var lod = d3.select('input[name="lod"]:checked').node().value;
d3.selectAll(".lod")
    .on("change", function() {
        lod = d3.select('input[name="lod"]:checked').node().value;
        // console.log("lod: " + lod);
});

var encoding = d3.select('input[name="encoding"]:checked').node().value;;
d3.selectAll(".encoding")
    .on("change", function() {
        encoding = d3.select('input[name="encoding"]:checked').node().value;
        // console.log("encoding: " + encoding);
});

// setup species selection list
d3.select("#species")
    .selectAll("option")
    .data(species)
    .enter()
    .append("option")
    .attr("value", (d) => {return d})
    .text((d) => {return d});

var species_select = d3.select('#species').property('value');
d3.select("#species")
    .on("change", function() {
        species_select = d3.select('#species').property("value");
        // console.log("species_selected: " + species_select);
});

function setupSvgMap() {
    // setup map visualization
    d3.json("/first", {
        method: "POST",
        body: JSON.stringify({
            top_left_x: 0,
            top_left_y: 0,
            top_right_x: 0,
            top_right_y: 0,
            bottom_right_x: 0,
            bottom_right_y: 0,
            bottom_left_x: 0,
            bottom_left_y: 0,
        }),
        headers: {
            "Content-type": "application/json; charset=UTF-8"
        }
    })
    .then(function(data) {
        d3.json("./countries-110m.json")
        .then(function(world_map) {

            svgMap.append("g")
                .attr("class", "earth-borders")
                .selectAll("path")
                .data([earth_border])
                .enter()
                .append("path")
                .attr("d", path)
                .attr("stroke", "black")
                .attr("stroke-witdth", 0.5)
                .style("fill", "#d6ffff");

            svgMap.append("g")
                .attr("class", "countries")
                .selectAll("path")
                .data(topojson.feature(world_map, world_map.objects.countries).features)
                .enter()
                .append("path")
                .attr("d", path)
                .attr("fill", "white")
                .attr("stroke", "black")
                .attr("stroke-width", 0.5)
                .on("mouseover", function(event, d) {
                    d3.select(this)
                    .transition().duration(200)
                    .style("fill", "rgba(107, 194, 81, 0.5)");
                    
                    tt.transition()        
                    .duration(200)      
                    .style("opacity", 1)
                    .style("width", "120px")
                    .style("height", "60px");
                
                    tt.html(d.properties.name)
                    .style("left", event.clientX + 15 + "px")     
                    .style("top", event.clientY + 15 + "px"); 
                })
                .on("mousemove", function(event, d) {   
                    tt.html(d.properties.name)
                    .style("left", event.clientX + 15 + "px")     
                    .style("top", event.clientY + 15 + "px"); 
                })
                .on("mouseout", function() {
                    d3.select(this)
                    .transition().duration(200)
                    .style("fill", "white");
                    
                    tt.transition()        
                    .duration(200)      
                    .style("opacity", 0); 
                });

            svgMap.append("g")
                .attr("class", "graticule")
                .selectAll("path")
                .data([d3.geoGraticule10()])
                .enter()
                .append("path")
                .attr("d", path)
                .attr("stroke", "black")
                .attr("stroke-width", 0.1)
                .style("fill", "None");
        })
    });
}

setupSvgMap();